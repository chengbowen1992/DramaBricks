<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒæ‹³æ‰“ç –å—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #0a0a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            color: white;
        }
        .container {
            display: flex;
            gap: 20px;
            padding: 20px;
        }
        .panel {
            background: #16213e;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .panel h3 {
            margin-bottom: 10px;
            color: #e94560;
            font-size: 14px;
        }
        #videoCanvas {
            border-radius: 8px;
            transform: scaleX(-1);
        }
        #gameCanvas {
            border-radius: 8px;
            background: #0f0f23;
        }
        .status {
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }
        .status .active { color: #4ade80; }
        .status .inactive { color: #ef4444; }
        .instructions {
            background: #1e3a5f;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
            line-height: 1.6;
        }
        .instructions h4 {
            color: #60a5fa;
            margin-bottom: 8px;
        }
        .hand-indicator {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .hand {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
        }
        .hand.left { background: #3b82f6; }
        .hand.right { background: #ef4444; }
        .hand.detected { opacity: 1; }
        .hand.not-detected { opacity: 0.3; }
        .debug-panel {
            background: #0d1b2a;
            border: 1px solid #1e3a5f;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 11px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        .debug-panel h4 {
            color: #fbbf24;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .debug-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            padding: 2px 0;
            border-bottom: 1px solid #1e3a5f33;
        }
        .debug-label { color: #888; }
        .debug-row span:last-child {
            color: #4ade80;
            font-weight: bold;
        }
        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }
        .score-display .score {
            font-size: 32px;
            font-weight: bold;
        }
        .score-display .label {
            font-size: 12px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel">
            <h3>ğŸ“· æ‘„åƒå¤´ (åŒæ‹³æ£€æµ‹)</h3>
            <canvas id="videoCanvas" width="480" height="360"></canvas>
            <div class="hand-indicator">
                <div id="leftHandStatus" class="hand left not-detected">å·¦æ‹³: æœªæ£€æµ‹</div>
                <div id="rightHandStatus" class="hand right not-detected">å³æ‹³: æœªæ£€æµ‹</div>
            </div>
            <div class="status">
                çŠ¶æ€: <span id="status">æ­£åœ¨åˆå§‹åŒ–...</span>
            </div>
            <div class="debug-panel">
                <h4>è°ƒè¯•ä¿¡æ¯</h4>
                <div class="debug-row">
                    <span class="debug-label">æŒ¡æ¿è§’åº¦:</span>
                    <span id="debugAngle">0Â°</span>
                </div>
                <div class="debug-row">
                    <span class="debug-label">æŒ¡æ¿ä½ç½®:</span>
                    <span id="debugPaddleX">-</span>
                </div>
                <div class="debug-row">
                    <span class="debug-label">åŒæ‹³ä¸­å¿ƒ:</span>
                    <span id="debugCenter">-</span>
                </div>
                <div class="debug-row">
                    <span class="debug-label">çƒæ•°é‡:</span>
                    <span id="debugBalls">0</span>
                </div>
            </div>
        </div>
        <div class="panel">
            <h3>ğŸ® åŒæ‹³æ‰“ç –å—</h3>
            <canvas id="gameCanvas" width="480" height="600"></canvas>
            <div class="score-display">
                <div class="label">å¾—åˆ†</div>
                <div class="score" id="scoreDisplay">0</div>
            </div>
            <div class="instructions">
                <h4>æ“ä½œè¯´æ˜</h4>
                <p>âœŠâœŠ <strong>åŒæ‹³è¿çº¿</strong> â†’ æ§åˆ¶æŒ¡æ¿å€¾æ–œè§’åº¦</p>
                <p>â†”ï¸ <strong>åŒæ‹³ä¸€èµ·ç§»åŠ¨</strong> â†’ æŒ¡æ¿å·¦å³ç§»åŠ¨</p>
                <p>ğŸ–ï¸ğŸ–ï¸ <strong>åŒæ‰‹å¼ å¼€</strong> â†’ å‘å°„æ–°çƒ</p>
            </div>
        </div>
    </div>

    <!-- MediaPipe Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        // ============ æ¸¸æˆçŠ¶æ€ ============
        const game = {
            // æŒ¡æ¿
            paddle: {
                x: 240,
                y: 550,
                width: 100,
                height: 15,
                angle: 0  // å¼§åº¦
            },
            // çƒ
            balls: [],
            ballSpeed: 6,
            ballRadius: 8,
            // ç –å—
            bricks: [],
            brickRows: 5,
            brickCols: 8,
            brickWidth: 55,
            brickHeight: 20,
            brickPadding: 5,
            brickOffsetTop: 50,
            brickOffsetLeft: 15,
            // åˆ†æ•°
            score: 0,
            // æ‰‹åŠ¿çŠ¶æ€
            leftHand: {
                detected: false,
                isOpen: false,
                x: 0,
                y: 0
            },
            rightHand: {
                detected: false,
                isOpen: false,
                x: 0,
                y: 0
            },
            // åŒæ‹³æ§åˆ¶
            bothFistsDetected: false,
            prevCenterX: 0.5,
            hasPrevCenter: false,
            bothWereOpen: false  // ç”¨äºæ£€æµ‹åŒæ‰‹å¼ å¼€
        };

        // ============ Canvas è®¾ç½® ============
        const videoCanvas = document.getElementById('videoCanvas');
        const videoCtx = videoCanvas.getContext('2d');
        const gameCanvas = document.getElementById('gameCanvas');
        const gameCtx = gameCanvas.getContext('2d');

        // ============ åˆå§‹åŒ–ç –å— ============
        function initBricks() {
            game.bricks = [];
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'];
            for (let row = 0; row < game.brickRows; row++) {
                for (let col = 0; col < game.brickCols; col++) {
                    game.bricks.push({
                        x: game.brickOffsetLeft + col * (game.brickWidth + game.brickPadding),
                        y: game.brickOffsetTop + row * (game.brickHeight + game.brickPadding),
                        width: game.brickWidth,
                        height: game.brickHeight,
                        color: colors[row],
                        alive: true
                    });
                }
            }
        }

        // ============ æ‰‹åŠ¿è¯†åˆ«å·¥å…·å‡½æ•° ============
        function isHandOpen(landmarks) {
            const fingerTips = [8, 12, 16, 20];
            const fingerPIPs = [6, 10, 14, 18];
            let extendedFingers = 0;
            for (let i = 0; i < 4; i++) {
                if (landmarks[fingerTips[i]].y < landmarks[fingerPIPs[i]].y) {
                    extendedFingers++;
                }
            }
            return extendedFingers >= 3;
        }

        function getPalmCenter(landmarks) {
            return {
                x: (landmarks[0].x + landmarks[9].x) / 2,
                y: (landmarks[0].y + landmarks[9].y) / 2
            };
        }

        // ============ MediaPipe æ‰‹åŠ¿æ£€æµ‹ ============
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        function onResults(results) {
            videoCtx.save();
            videoCtx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
            videoCtx.drawImage(results.image, 0, 0, videoCanvas.width, videoCanvas.height);

            // ä¿å­˜ä¸Šä¸€å¸§çŠ¶æ€
            const prevBothOpen = game.leftHand.isOpen && game.rightHand.isOpen &&
                                  game.leftHand.detected && game.rightHand.detected;

            // é‡ç½®
            game.leftHand.detected = false;
            game.rightHand.detected = false;

            if (results.multiHandLandmarks && results.multiHandedness) {
                for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                    const landmarks = results.multiHandLandmarks[i];
                    const handedness = results.multiHandedness[i];
                    const isLeftHand = handedness.label === 'Right'; // é•œåƒ

                    drawHandLandmarks(landmarks, isLeftHand ? '#3b82f6' : '#ef4444');

                    const isOpen = isHandOpen(landmarks);
                    const palmCenter = getPalmCenter(landmarks);

                    if (isLeftHand) {
                        game.leftHand.detected = true;
                        game.leftHand.isOpen = isOpen;
                        game.leftHand.x = palmCenter.x;
                        game.leftHand.y = palmCenter.y;
                    } else {
                        game.rightHand.detected = true;
                        game.rightHand.isOpen = isOpen;
                        game.rightHand.x = palmCenter.x;
                        game.rightHand.y = palmCenter.y;
                    }
                }
            }

            // æ£€æµ‹åŒæ‹³çŠ¶æ€
            game.bothFistsDetected = game.leftHand.detected && game.rightHand.detected &&
                                      !game.leftHand.isOpen && !game.rightHand.isOpen;

            // æ£€æµ‹åŒæ‰‹éƒ½å¼ å¼€ â†’ å‘å°„çƒ
            const bothOpen = game.leftHand.detected && game.rightHand.detected &&
                             game.leftHand.isOpen && game.rightHand.isOpen;

            if (bothOpen && !prevBothOpen) {
                launchBall();
            }

            videoCtx.restore();
            updateUI();
        }

        function drawHandLandmarks(landmarks, color) {
            const connections = [
                [0,1],[1,2],[2,3],[3,4],
                [0,5],[5,6],[6,7],[7,8],
                [0,9],[9,10],[10,11],[11,12],
                [0,13],[13,14],[14,15],[15,16],
                [0,17],[17,18],[18,19],[19,20],
                [5,9],[9,13],[13,17]
            ];

            videoCtx.strokeStyle = color;
            videoCtx.lineWidth = 2;

            for (const [i, j] of connections) {
                videoCtx.beginPath();
                videoCtx.moveTo(landmarks[i].x * videoCanvas.width, landmarks[i].y * videoCanvas.height);
                videoCtx.lineTo(landmarks[j].x * videoCanvas.width, landmarks[j].y * videoCanvas.height);
                videoCtx.stroke();
            }

            for (const point of landmarks) {
                videoCtx.beginPath();
                videoCtx.arc(point.x * videoCanvas.width, point.y * videoCanvas.height, 4, 0, 2 * Math.PI);
                videoCtx.fillStyle = color;
                videoCtx.fill();
            }
        }

        // ============ æ¸¸æˆé€»è¾‘ ============

        function launchBall() {
            // å‘å°„æ–¹å‘å‚ç›´äºæŒ¡æ¿ï¼ˆå‘ä¸Šåè½¬æŒ¡æ¿è§’åº¦ï¼‰
            const angle = game.paddle.angle - Math.PI / 2;
            game.balls.push({
                x: game.paddle.x,
                y: game.paddle.y - 20,
                vx: Math.cos(angle) * game.ballSpeed,
                vy: Math.sin(angle) * game.ballSpeed
            });
        }

        function updateGame() {
            // åŒæ‹³æ§åˆ¶æŒ¡æ¿
            if (game.leftHand.detected && game.rightHand.detected) {
                // é•œåƒåçš„åæ ‡ï¼ˆè§†é¢‘æ˜¯é•œåƒæ˜¾ç¤ºçš„ï¼‰
                const leftX = 1 - game.leftHand.x;
                const rightX = 1 - game.rightHand.x;
                const leftY = game.leftHand.y;
                const rightY = game.rightHand.y;

                // è®¡ç®—åŒæ‹³è¿çº¿è§’åº¦ï¼ˆç”¨é•œåƒåçš„åæ ‡ï¼‰
                const dx = rightX - leftX;
                const dy = rightY - leftY;
                let angle = Math.atan2(dy, dx);

                // é™åˆ¶è§’åº¦èŒƒå›´ (-60Â° åˆ° 60Â°)
                const maxAngle = Math.PI / 3;
                angle = Math.max(-maxAngle, Math.min(maxAngle, angle));
                game.paddle.angle = angle;

                // è®¡ç®—åŒæ‹³ä¸­å¿ƒç‚¹ï¼ˆç”¨é•œåƒåçš„åæ ‡ï¼‰
                const centerX = (leftX + rightX) / 2;

                // ä¸­å¿ƒç‚¹æ§åˆ¶æŒ¡æ¿ä½ç½®
                game.paddle.x = centerX * gameCanvas.width;
                game.paddle.x = Math.max(game.paddle.width/2,
                                Math.min(gameCanvas.width - game.paddle.width/2, game.paddle.x));
            }

            // æ›´æ–°çƒ
            for (let i = game.balls.length - 1; i >= 0; i--) {
                const ball = game.balls[i];

                ball.x += ball.vx;
                ball.y += ball.vy;

                // å¢™å£ç¢°æ’
                if (ball.x - game.ballRadius < 0 || ball.x + game.ballRadius > gameCanvas.width) {
                    ball.vx = -ball.vx;
                    ball.x = Math.max(game.ballRadius, Math.min(gameCanvas.width - game.ballRadius, ball.x));
                }
                if (ball.y - game.ballRadius < 0) {
                    ball.vy = -ball.vy;
                    ball.y = game.ballRadius;
                }

                // çƒè½å‡ºåº•éƒ¨
                if (ball.y > gameCanvas.height + 50) {
                    game.balls.splice(i, 1);
                    continue;
                }

                // æŒ¡æ¿ç¢°æ’ï¼ˆç®€åŒ–ï¼šçŸ©å½¢ç¢°æ’ï¼‰
                if (checkPaddleCollision(ball)) {
                    // æ ¹æ®æŒ¡æ¿è§’åº¦åå¼¹
                    const normal = game.paddle.angle - Math.PI / 2;
                    const speed = Math.sqrt(ball.vx * ball.vx + ball.vy * ball.vy);

                    // è®¡ç®—åå¼¹æ–¹å‘ï¼ˆåŠ å…¥ä¸€äº›éšæœºæ€§é¿å…æ— é™å¾ªç¯ï¼‰
                    const hitPos = (ball.x - game.paddle.x) / (game.paddle.width / 2);
                    const bounceAngle = normal + hitPos * 0.5;

                    ball.vx = Math.cos(bounceAngle) * speed;
                    ball.vy = Math.sin(bounceAngle) * speed;

                    // ç¡®ä¿çƒå‘ä¸Š
                    if (ball.vy > 0) ball.vy = -ball.vy;

                    ball.y = game.paddle.y - game.ballRadius - game.paddle.height/2 - 1;
                }

                // ç –å—ç¢°æ’
                for (const brick of game.bricks) {
                    if (brick.alive && checkBrickCollision(ball, brick)) {
                        brick.alive = false;
                        ball.vy = -ball.vy;
                        game.score += 10;
                        break;
                    }
                }
            }

            // æ£€æŸ¥æ¸¸æˆèƒœåˆ©
            if (game.bricks.every(b => !b.alive)) {
                initBricks();
                game.score += 100;
            }
        }

        function checkPaddleCollision(ball) {
            const paddleLeft = game.paddle.x - game.paddle.width / 2;
            const paddleRight = game.paddle.x + game.paddle.width / 2;
            const paddleTop = game.paddle.y - game.paddle.height / 2;
            const paddleBottom = game.paddle.y + game.paddle.height / 2;

            return ball.x + game.ballRadius > paddleLeft &&
                   ball.x - game.ballRadius < paddleRight &&
                   ball.y + game.ballRadius > paddleTop &&
                   ball.y - game.ballRadius < paddleBottom &&
                   ball.vy > 0;
        }

        function checkBrickCollision(ball, brick) {
            return ball.x + game.ballRadius > brick.x &&
                   ball.x - game.ballRadius < brick.x + brick.width &&
                   ball.y + game.ballRadius > brick.y &&
                   ball.y - game.ballRadius < brick.y + brick.height;
        }

        function renderGame() {
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

            // èƒŒæ™¯
            gameCtx.fillStyle = '#0f0f23';
            gameCtx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

            // ç»˜åˆ¶ç –å—
            for (const brick of game.bricks) {
                if (brick.alive) {
                    gameCtx.fillStyle = brick.color;
                    gameCtx.shadowColor = brick.color;
                    gameCtx.shadowBlur = 8;
                    gameCtx.fillRect(brick.x, brick.y, brick.width, brick.height);
                    gameCtx.shadowBlur = 0;

                    // é«˜å…‰
                    gameCtx.fillStyle = 'rgba(255,255,255,0.3)';
                    gameCtx.fillRect(brick.x, brick.y, brick.width, 3);
                }
            }

            // ç»˜åˆ¶æŒ¡æ¿ï¼ˆå¯æ—‹è½¬ï¼‰
            gameCtx.save();
            gameCtx.translate(game.paddle.x, game.paddle.y);
            gameCtx.rotate(game.paddle.angle);

            // æŒ¡æ¿ä¸»ä½“
            const gradient = gameCtx.createLinearGradient(0, -game.paddle.height/2, 0, game.paddle.height/2);
            gradient.addColorStop(0, '#60a5fa');
            gradient.addColorStop(1, '#3b82f6');
            gameCtx.fillStyle = gradient;
            gameCtx.shadowColor = '#3b82f6';
            gameCtx.shadowBlur = 15;
            gameCtx.fillRect(-game.paddle.width/2, -game.paddle.height/2, game.paddle.width, game.paddle.height);
            gameCtx.shadowBlur = 0;

            // æŒ¡æ¿è¾¹æ¡†
            gameCtx.strokeStyle = '#93c5fd';
            gameCtx.lineWidth = 2;
            gameCtx.strokeRect(-game.paddle.width/2, -game.paddle.height/2, game.paddle.width, game.paddle.height);

            // æ–¹å‘æŒ‡ç¤ºç®­å¤´
            gameCtx.fillStyle = '#ffffff';
            gameCtx.beginPath();
            gameCtx.moveTo(0, -game.paddle.height/2 - 15);
            gameCtx.lineTo(-8, -game.paddle.height/2 - 5);
            gameCtx.lineTo(8, -game.paddle.height/2 - 5);
            gameCtx.closePath();
            gameCtx.fill();

            gameCtx.restore();

            // ç»˜åˆ¶çƒ
            for (const ball of game.balls) {
                gameCtx.beginPath();
                gameCtx.arc(ball.x, ball.y, game.ballRadius, 0, Math.PI * 2);
                gameCtx.fillStyle = '#fbbf24';
                gameCtx.shadowColor = '#fbbf24';
                gameCtx.shadowBlur = 15;
                gameCtx.fill();
                gameCtx.shadowBlur = 0;
            }

            // æç¤ºæ–‡å­—
            if (game.balls.length === 0) {
                gameCtx.fillStyle = 'rgba(255,255,255,0.8)';
                gameCtx.font = '18px Segoe UI';
                gameCtx.textAlign = 'center';
                gameCtx.fillText('ğŸ–ï¸ğŸ–ï¸ åŒæ‰‹å¼ å¼€å‘å°„çƒï¼', gameCanvas.width/2, gameCanvas.height/2);
            }
        }

        function gameLoop() {
            updateGame();
            renderGame();
            requestAnimationFrame(gameLoop);
        }

        // ============ UI æ›´æ–° ============
        function updateUI() {
            const leftStatus = document.getElementById('leftHandStatus');
            const rightStatus = document.getElementById('rightHandStatus');

            if (game.leftHand.detected) {
                leftStatus.className = 'hand left detected';
                leftStatus.textContent = `å·¦: ${game.leftHand.isOpen ? 'ğŸ–ï¸' : 'âœŠ'}`;
            } else {
                leftStatus.className = 'hand left not-detected';
                leftStatus.textContent = 'å·¦: -';
            }

            if (game.rightHand.detected) {
                rightStatus.className = 'hand right detected';
                rightStatus.textContent = `å³: ${game.rightHand.isOpen ? 'ğŸ–ï¸' : 'âœŠ'}`;
            } else {
                rightStatus.className = 'hand right not-detected';
                rightStatus.textContent = 'å³: -';
            }

            // è°ƒè¯•ä¿¡æ¯
            const angleDeg = (game.paddle.angle * 180 / Math.PI).toFixed(1);
            document.getElementById('debugAngle').textContent = `${angleDeg}Â°`;
            document.getElementById('debugPaddleX').textContent = game.paddle.x.toFixed(0);

            if (game.leftHand.detected && game.rightHand.detected) {
                const cx = ((game.leftHand.x + game.rightHand.x) / 2).toFixed(2);
                document.getElementById('debugCenter').textContent = cx;
            } else {
                document.getElementById('debugCenter').textContent = '-';
            }

            document.getElementById('debugBalls').textContent = game.balls.length;
            document.getElementById('scoreDisplay').textContent = game.score;
        }

        // ============ åˆå§‹åŒ– ============
        async function init() {
            const statusEl = document.getElementById('status');

            initBricks();

            try {
                statusEl.innerHTML = '<span class="inactive">æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...</span>';

                const video = document.createElement('video');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                video.srcObject = stream;
                await video.play();

                statusEl.innerHTML = '<span class="inactive">æ­£åœ¨åŠ è½½æ‰‹åŠ¿è¯†åˆ«æ¨¡å‹...</span>';

                const camera = new Camera(video, {
                    onFrame: async () => {
                        await hands.send({ image: video });
                    },
                    width: 640,
                    height: 480
                });

                await camera.start();

                statusEl.innerHTML = '<span class="active">âœ“ è¿è¡Œä¸­</span>';

                gameLoop();

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                statusEl.innerHTML = `<span class="inactive">é”™è¯¯: ${error.message}</span>`;
            }
        }

        init();
    </script>
</body>
</html>
